<!DOCTYPE html>
<html class="writer-html5" lang="ro" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>6.2. Customize local DB models &mdash; QWAT 1.0 documentație</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/translations.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Căutare" href="../search.html" />
    <link rel="next" title="6.4. Upgrade database" href="upgrade.html" />
    <link rel="prev" title="6.1. QWAT Development Overview" href="qwat_dev.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            QWAT
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../features-guide/index.html">1. QWAT / TEKSI drinking water module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation-guide/index.html">2. QWAT Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user-guide/index.html">3. QWAT User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">4. Admin Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributor-guide/index.html">5. Contributor’s guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">6. Developer’s guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="qwat_dev.html">6.1. QWAT Development Overview</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">6.2. Customize local DB models</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#customizing-the-data-model">6.2.1. Customizing the data model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-a-field">6.2.2. Adding a field</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-a-table">6.2.3. Adding a table</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#create-an-extension">6.3. Create an extension</a></li>
<li class="toctree-l2"><a class="reference internal" href="upgrade.html">6.4. Upgrade database</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../demo-guide/index.html">7. Demo data and project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/index.html">8. FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary/index.html">9. Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../translation/index.html">10. Translation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">QWAT</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html"><span class="section-number">6. </span>Developer’s guide</a></li>
      <li class="breadcrumb-item active"><span class="section-number">6.2. </span>Customize local DB models</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/developer-guide/local_customizations.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="customize-local-db-models">
<h1><span class="section-number">6.2. </span>Customize local DB models<a class="headerlink" href="#customize-local-db-models" title="Permalink to this heading"></a></h1>
<p>Since QWAT 1.3.2, customization process and extension have been formalised.</p>
<p>An <strong>extension is a core data model customization</strong> that is part of a dedicated repository. It can be activated at any time, using its own initialization script.
An extension can follows the core data model life cycle, which means that fixing or improving a core extension will require a QWAT update, but can have an own life cycle.
Currently, the only existing extension is the <a class="reference external" href="https://github.com/qwat/extension_sire">SIRE export extension</a>. Note that it extends the value lists and is modified the qwat core right now.</p>
<p>A <strong>local customization</strong> will follow exactly the same developpement rules as an extension, except that it must be stored in a separate repository, apart from QWAT core directories.
local customizations must be first initialized manually and then applied in QWAT migration process using upgrade_db.sh specific option to add additional directories.</p>
<p>Both extension and customizations require the following :</p>
<ul class="simple">
<li><p>a init script, adding the necessary informations to the model</p></li>
<li><p>a set of update scripts used when upgrading QWAT core data model :</p>
<ul>
<li><p>a pre-all.py script wich will eventually drop all additionnal views, trigger function or any dependencies locking the data model upgrade</p></li>
<li><p>a set of SQL files prefixed with a version number inlined with QWAT core data model versions (ex: 1.3.1.001_local_Pully_script)</p></li>
<li><p>a post-all.py script restoring the necessary dependencies once the core model and the extension/customization have been applied</p></li>
</ul>
</li>
</ul>
<p>A full example is provided in the <a class="reference external" href="https://github.com/qwat/qwat-data-model/tree/master/.build/customizations/sigip">.build/customizations/sigip</a> folder or the <a class="reference external" href="https://github.com/qwat/extension_sire">SIRE extension</a>.</p>
<section id="customizing-the-data-model">
<h2><span class="section-number">6.2.1. </span>Customizing the data model<a class="headerlink" href="#customizing-the-data-model" title="Permalink to this heading"></a></h2>
<p>This part concerns the modification of the data model to add specific objects, on top on QWAT core data model.
While there is full freedom for using PostGIS and PostgreSQL capabilities, here are the conventions and good practices for the QWAT project.</p>
<p>Allowed customization for QWAT are :</p>
<ul class="simple">
<li><p>Adding a custom field</p></li>
<li><p>Adding a custom table</p></li>
</ul>
<p>No change of the core data model is allowed (field names, types, constraints…), or you should <a class="reference external" href="../contributor-guide/index.html#data-model-changes">ask for the QWAT data model to be modified centrally</a>.</p>
</section>
<section id="adding-a-field">
<h2><span class="section-number">6.2.2. </span>Adding a field<a class="headerlink" href="#adding-a-field" title="Permalink to this heading"></a></h2>
<p>If you want to add a field to one of the core data model tables, follow these steps</p>
<ul class="simple">
<li><p>Store all modifications as separate SQL scripts. NEVER modify directly your database structure.</p></li>
<li><p>Any added field or table <strong>must</strong> have the prefix <cite>usr_</cite></p></li>
<li><p>keep in mind that most views are generated by the initialization script. The field will be automatically added to the views if you use the initialization process and include pre and post file to drop and recreate the views.</p></li>
<li><p>The simplest approach is to keep one unique SQL script applied after all core delta upgrade files. Currently (1.3.0) the file must named like <cite>vx.x.x</cite> and version number must be higher than latest core data model.</p></li>
</ul>
<p>Example : adding a paint color information to hydrants</p>
<ul class="simple">
<li><p>1 : add the attribute with pgadmin (you could also directly type SQL to modify the model)</p></li>
<li><p>2 : add the following SQL equivalent instruction to a <cite>usr_model.sql</cite> file</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">qwat_od</span><span class="p">.</span><span class="n">hydrant</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="n">usr_color</span><span class="w"> </span><span class="nb">integer</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>3 : add the following SQL instruction to a <cite>usr_model_drop.sql</cite> file</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w"> </span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">qwat_od</span><span class="p">.</span><span class="n">hydrant</span><span class="w"> </span><span class="k">DROP</span><span class="w"> </span><span class="k">COLUMN</span><span class="w"> </span><span class="n">usr_color</span><span class="w"> </span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="adding-a-table">
<h2><span class="section-number">6.2.3. </span>Adding a table<a class="headerlink" href="#adding-a-table" title="Permalink to this heading"></a></h2>
<p>Custom tables go to specific schemas prefixed with <cite>usr_</cite> . If you want to have additional custom tables, you should first ensure that such a custom schema exists.</p>
<p>If you want to add a table follow these steps</p>
<ul class="simple">
<li><p>Create a custom schema prefixed with <cite>usr_</cite></p></li>
<li><p>Add your table in this schema (table name is free)</p></li>
<li><p>You <strong>should</strong> write corresponding diff code against the core data model (see example below)</p></li>
<li><p>You <strong>could</strong> write corresponding delete diff code against the core data model (see example below)</p></li>
</ul>
<p>Example : adding color informations to hydrants</p>
<ul class="simple">
<li><p>1 : add the <cite>usr_cityservices</cite> schema, and the <cite>hydrant_paint</cite> table with pgadmin (you could also directly type SQL to modify the model)</p></li>
<li><p>2 : add the following SQL equivalent instruction to a <cite>usr_model.sql</cite> file</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="n">usr_cityservices</span><span class="p">;</span>
<span class="linenos">2</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">usr_cityservices</span><span class="p">.</span><span class="n">hydrant_paint</span><span class="w"> </span><span class="p">(</span>
<span class="linenos">3</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="nb">serial</span>
<span class="linenos">4</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">fk_hydrant</span><span class="w"> </span><span class="nb">integer</span>
<span class="linenos">5</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="nb">varchar</span>
<span class="linenos">6</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">paint_date</span><span class="w"> </span><span class="k">timestamp</span>
<span class="linenos">7</span><span class="p">);</span>
<span class="linenos">8</span><span class="w"> </span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">usr_cityservices</span><span class="p">.</span><span class="n">hydrant_paint</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="n">hydrant_fk</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">fk_hydrant</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">qwat_od</span><span class="p">.</span><span class="n">hydrant</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">MATCH</span><span class="w"> </span><span class="k">FULL</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>3 : add the following SQL instruction to a <cite>usr_model_drop.sql</cite> file</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="w"> </span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">usr_cityservices</span><span class="p">.</span><span class="n">hydrant_paint</span><span class="w"> </span><span class="k">DROP</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="n">hydrant_fk</span><span class="p">;</span>
<span class="linenos">2</span><span class="w"> </span><span class="k">DROP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">usr_cityservices</span><span class="p">.</span><span class="n">hydrant_paint</span><span class="p">;</span>
<span class="linenos">3</span><span class="w"> </span><span class="k">DROP</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="n">usr_cityservices</span><span class="p">;</span>
</pre></div>
</div>
</section>
</section>
<section id="create-an-extension">
<h1><span class="section-number">6.3. </span>Create an extension<a class="headerlink" href="#create-an-extension" title="Permalink to this heading"></a></h1>
<p>Extensions have dedicated repositories like SIRE Extension. To create an extension you have to make a new repository from the <a class="reference external" href="https://github.com/qwat/extension_template">template</a> and follow the procedure.</p>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="qwat_dev.html" class="btn btn-neutral float-left" title="6.1. QWAT Development Overview" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="upgrade.html" class="btn btn-neutral float-right" title="6.4. Upgrade database" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018, QWAT team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>